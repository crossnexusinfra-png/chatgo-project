# Laravel標準テーブルのカラム使用状況

## 1. password_reset_tokensテーブル

### **email** (PRIMARY KEY)
**使用状況**:
- **パスワードリセットトークンの対象ユーザーのメールアドレス**を指定
- **主キー**: メールアドレスが主キーとして使用される
- **使用箇所**:
  1. **トークンの生成**: Laravelの`Password::sendResetLink()`が呼ばれた際に使用
  2. **トークンの検証**: パスワードリセット時に、メールアドレスとトークンで検証
  3. **トークンの削除**: パスワードリセット完了後、トークンが削除される

**設定**: `config/auth.php` (96行目)
```php
'table' => env('AUTH_PASSWORD_RESET_TOKEN_TABLE', 'password_reset_tokens'),
```

**有効期限**: 60分（`config/auth.php` 97行目）
```php
'expire' => 60, // 60分
```

**スロットル**: 60秒（`config/auth.php` 98行目）
```php
'throttle' => 60, // 60秒間隔でトークン生成を制限
```

### **token**
**使用状況**:
- **パスワードリセット用のトークン**（ハッシュ化された値）
- **生成**: Laravelが自動的にランダムなトークンを生成し、ハッシュ化して保存
- **使用箇所**:
  1. **メール送信**: パスワードリセットメールに含まれるURLに使用
  2. **トークンの検証**: パスワードリセット画面で、メールアドレスとトークンで検証
  3. **セキュリティ**: ハッシュ化されているため、データベースから直接読み取っても元のトークンは分からない

**注意**: このトークンはハッシュ化されて保存されるため、元のトークン値は復元できません。

### **created_at**
**使用状況**:
- **トークンが作成された日時**を記録
- **使用箇所**:
  1. **有効期限の判定**: トークンが作成されてから60分以内かどうかを判定
  2. **古いトークンの削除**: 有効期限切れのトークンは自動的に削除される

**注意**: `nullable()`が設定されているため、NULLの可能性がありますが、通常は作成日時が記録されます。

---

## 2. sessionsテーブル

### **id** (PRIMARY KEY)
**使用状況**:
- **セッションID**（セッションの一意の識別子）
- **主キー**: セッションIDが主キーとして使用される
- **使用箇所**:
  1. **セッションの識別**: リクエストごとにセッションIDでセッションデータを取得
  2. **セッションの生成**: 新しいセッションが作成される際に、一意のIDが生成される
  3. **セッションの更新**: セッションデータが更新される際に、このIDで検索・更新

**設定**: `config/session.php` (89行目)
```php
'table' => env('SESSION_TABLE', 'sessions'),
```

**ドライバー**: `config/session.php` (21行目)
```php
'driver' => env('SESSION_DRIVER', 'database'),
```

### **user_id**
**使用状況**:
- **ログインしているユーザーのID**を指定
- **NULL可**: 非ログインユーザーの場合は`NULL`
- **インデックス**: ユーザーIDでインデックスが設定されている（高速検索のため）
- **使用箇所**:
  1. **ログイン状態の管理**: ログインしているユーザーを識別
  2. **セッションの検索**: 特定ユーザーのセッションを検索する際に使用
  3. **セッションの削除**: ユーザーがログアウトした際に、そのユーザーのセッションを削除

**実装**: Laravelの認証システムが自動的に管理
- ログイン時: `Auth::attempt()`が成功すると、`user_id`が設定される
- ログアウト時: `Auth::logout()`が呼ばれると、セッションが削除される

### **ip_address**
**使用状況**:
- **セッションを作成したクライアントのIPアドレス**を記録
- **型**: `string(45)` - IPv6アドレスに対応（最大45文字）
- **NULL可**: IPアドレスが取得できない場合は`NULL`
- **使用箇所**:
  1. **セキュリティ**: セッションハイジャックの検出に使用可能
  2. **ログ分析**: どのIPアドレスからアクセスがあったかを記録
  3. **現在は直接使用されていない**: 将来のセキュリティ機能拡張用

**注意**: 現在のアプリケーションコードでは直接使用されていませんが、Laravelが自動的に記録しています。

### **user_agent**
**使用状況**:
- **セッションを作成したクライアントのUser-Agent**を記録
- **型**: `text` - 長いUser-Agent文字列に対応
- **NULL可**: User-Agentが取得できない場合は`NULL`
- **使用箇所**:
  1. **セキュリティ**: セッションハイジャックの検出に使用可能
  2. **ログ分析**: どのブラウザ/デバイスからアクセスがあったかを記録
  3. **現在は直接使用されていない**: 将来のセキュリティ機能拡張用

**注意**: 現在のアプリケーションコードでは直接使用されていませんが、Laravelが自動的に記録しています。

### **payload**
**使用状況**:
- **セッションデータの本体**（暗号化されたJSON形式）
- **型**: `longText` - 大量のセッションデータに対応
- **使用箇所**:
  1. **セッションデータの保存**: すべてのセッションデータが暗号化されて保存される
  2. **セッションデータの取得**: リクエストごとに、このデータを復号化して使用
  3. **セッションデータの更新**: セッションデータが変更されると、このカラムが更新される

**保存されるデータの例**:
- `registration_data`: ユーザー登録時の一時データ
- `intended_url`: ログイン後にリダイレクトするURL
- `acknowledged_response_*`: レスポンス承認フラグ
- `current_language`: 現在の言語設定
- その他のセッションデータ

**暗号化**: `config/session.php` (50行目)
```php
'encrypt' => env('SESSION_ENCRYPT', false),
```

**実装例**: `AuthController.php` (48-55行目)
```php
$allSessionData = session()->all();
foreach ($allSessionData as $key => $value) {
    if (strpos($key, 'pending_acknowledge_response_') === 0) {
        $responseId = str_replace('pending_acknowledge_response_', '', $key);
        session(['acknowledged_response_' . $responseId => true]);
        session()->forget($key);
    }
}
```

### **last_activity**
**使用状況**:
- **セッションの最後の活動日時**（Unixタイムスタンプ形式）
- **型**: `integer` - Unixタイムスタンプ（秒単位）
- **インデックス**: 最後の活動日時でインデックスが設定されている（古いセッションの削除に使用）
- **使用箇所**:
  1. **セッションの有効期限判定**: 最後の活動から一定時間（デフォルト120分）経過したセッションを削除
  2. **古いセッションの削除**: `last_activity`が古いセッションを自動的に削除（ガベージコレクション）
  3. **セッションの更新**: リクエストごとに、この値が更新される

**有効期限**: `config/session.php` (35行目)
```php
'lifetime' => (int) env('SESSION_LIFETIME', 120), // 120分
```

**ガベージコレクション**: `config/session.php` (117行目)
```php
'lottery' => [2, 100], // 2%の確率で古いセッションを削除
```

---

## 各テーブルの処理フロー

### password_reset_tokensテーブル

1. **パスワードリセットリクエスト**
   - ユーザーがパスワードリセットをリクエスト
   - Laravelがランダムなトークンを生成し、ハッシュ化して保存
   - メールアドレスを主キーとして、トークンと作成日時を保存

2. **パスワードリセットメール送信**
   - メールにリセットURL（トークンを含む）を送信

3. **パスワードリセット**
   - ユーザーがリセットURLにアクセス
   - メールアドレスとトークンで検証
   - 有効期限内（60分）であれば、パスワードをリセット
   - トークンを削除

4. **トークンの有効期限**
   - 作成から60分経過したトークンは無効
   - 古いトークンは自動的に削除される

### sessionsテーブル

1. **セッションの作成**
   - ユーザーが初めてアクセスした際に、新しいセッションが作成される
   - セッションID、IPアドレス、User-Agent、`last_activity`が記録される

2. **ログイン**
   - `Auth::attempt()`が成功すると、`user_id`が設定される
   - `payload`に認証情報が保存される
   - `last_activity`が更新される

3. **セッションデータの保存**
   - `session(['key' => 'value'])`でセッションデータを保存
   - `payload`カラムに暗号化されて保存される

4. **セッションデータの取得**
   - リクエストごとに、セッションIDでセッションデータを取得
   - `payload`を復号化して、セッションデータを使用

5. **セッションの更新**
   - リクエストごとに、`last_activity`が更新される
   - セッションデータが変更されると、`payload`が更新される

6. **セッションの削除**
   - ログアウト時: `Auth::logout()`が呼ばれると、セッションが削除される
   - 有効期限切れ: 最後の活動から120分経過したセッションは自動的に削除される
   - ガベージコレクション: 2%の確率で古いセッションが削除される

---

## まとめ

| テーブル | 主な用途 | 重要なカラム |
|---------|---------|------------|
| `password_reset_tokens` | パスワードリセットトークンの管理 | `email` (PK), `token`, `created_at` |
| `sessions` | セッションデータの管理 | `id` (PK), `user_id`, `payload`, `last_activity` |

### 共通の特徴

1. **Laravel標準機能**: 両方のテーブルはLaravelフレームワークによって自動的に管理される
2. **自動削除**: 有効期限切れのデータは自動的に削除される
3. **セキュリティ**: トークンはハッシュ化、セッションデータは暗号化される
4. **設定可能**: `config/auth.php`と`config/session.php`で設定を変更可能

### 注意事項

1. **password_reset_tokens**:
   - 現在のアプリケーションでは、パスワードリセット機能が実装されていない可能性があります
   - 実装する場合は、Laravelの標準機能を使用できます

2. **sessions**:
   - セッションドライバーが`database`に設定されている場合のみ使用されます
   - 他のドライバー（`file`, `redis`など）を使用している場合は、このテーブルは使用されません

3. **データ量の管理**:
   - 両方のテーブルは自動的に古いデータが削除されますが、大量のデータが蓄積される可能性があります
   - 定期的なメンテナンスを検討してください

