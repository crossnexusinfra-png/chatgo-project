# フレンド申請可能条件の詳細

## フレンド申請可能となる条件

### 1. **基本的な禁止条件**

以下の場合は申請できません：

- **自分自身には申請できない**
- **既にフレンドの場合**（`friendships`テーブルにレコードが存在する）
- **既に申請中（pending）の場合**（`friend_requests`テーブルに`status='pending'`のレコードが存在する）

### 2. **通常の申請条件（招待関係がない場合）**

同じスレッド内で以下の条件を**すべて満たす**必要があります：

#### 条件1: お互いに10通以上送信
- ユーザーA → ユーザーB: **10通以上**
- ユーザーB → ユーザーA: **10通以上**

#### 条件2: 双方それぞれ1000文字以上送信
- ユーザーA → ユーザーB: **1000文字以上**
- ユーザーB → ユーザーA: **1000文字以上**

#### 条件3: 12時間以内に相互に送信
- 最後の相互送信の時間差が**12時間以内**（43200秒以内）

**実装箇所**: `FriendService::checkThreadInteraction()` (141-186行目)

```php
// 条件チェックの流れ
1. ThreadInteractionテーブルから相互送信の記録を取得
2. 同じスレッド内で、お互いに10通以上送信したかチェック
3. 双方それぞれ1000文字以上送信したかチェック
4. 最後の相互送信の時間差が12時間以内かチェック
```

### 3. **招待関係がある場合（例外）**

**招待関係がある場合は、通常の条件を満たさなくても申請可能**です。

- ユーザーAがユーザーBを招待した、または
- ユーザーBがユーザーAを招待した

場合、既にフレンドでない限り、申請ボタンが表示されます。

**実装箇所**: `FriendService::getAvailableFriendRequests()` (391-452行目)

```php
if ($invite) {
    // 招待関係がある場合は、既にフレンドでない限り申請可能
    if (!$friendship) {
        $canSend = true;
    }
}
```

### 4. **その他の制限**

#### 最大フレンド数
- **最大10人まで**フレンドになれます
- 10人に達している場合は、新しい申請を送信できません

**実装箇所**: `FriendService::isMaxFriendsReached()` (506-509行目)

```php
public function isMaxFriendsReached(User $user): bool
{
    return $this->getFriendCount($user) >= 10;
}
```

#### 申請拒否時の条件リセット
- 申請が拒否（rejected）された場合、以下のデータが削除されます：
  - `ThreadInteraction`テーブルの相互送信記録
  - `UserInvite`テーブルの招待関係

これにより、再度同じ条件を満たす必要があります。

**実装箇所**: `FriendService::resetFriendRequestConditions()` (457-476行目)

---

## フレンド機能が有効になる条件（別機能）

フレンド機能を使用するには、以下の条件を**すべて満たす**必要があります：

1. **総ログイン数**: 5日以上
2. **スレッド作成数**: 1個以上
3. **レスポンス送信数**: 15回以上

**実装箇所**: `FriendService::isFriendFeatureEnabled()` (18-43行目)

**注意**: この条件は「フレンド機能を使用できるか」を判定するもので、「フレンド申請を送信できるか」とは別の条件です。

---

## 申請可能条件のまとめ

| 状況 | 申請可能か |
|------|----------|
| 自分自身 | ❌ 不可 |
| 既にフレンド | ❌ 不可 |
| 既に申請中（pending） | ❌ 不可 |
| 最大フレンド数（10人）に達している | ❌ 不可 |
| **招待関係がある** | ✅ **可能（条件を満たさなくてもOK）** |
| **通常の条件を満たしている** | ✅ **可能** |
| 通常の条件を満たしていない | ❌ 不可 |

---

## 通常の申請条件の詳細

### 条件を満たすための具体的な例

**例**: ユーザーAとユーザーBが同じスレッドで会話している場合

1. **ユーザーAがユーザーBに10通以上、合計1000文字以上送信**
2. **ユーザーBがユーザーAに10通以上、合計1000文字以上送信**
3. **最後の相互送信の時間差が12時間以内**

この3つの条件を**すべて満たした時点で**、フレンド申請ボタンが表示されます。

### データの追跡

相互送信の記録は`thread_interactions`テーブルで管理されています：

- `user_id`: 送信者
- `other_user_id`: 受信者
- `thread_id`: スレッドID
- `message_count`: 送信回数
- `total_characters`: 合計文字数
- `last_interaction_at`: 最後の送信日時

**実装箇所**: `ResponseController`でレスポンス送信時に自動的に記録されます。

---

## 申請拒否時の動作

申請が拒否（rejected）された場合：

1. `friend_requests`テーブルの`status`が`'rejected'`に更新される
2. `ThreadInteraction`テーブルの相互送信記録が**削除**される
3. `UserInvite`テーブルの招待関係が**削除**される

これにより、再度同じ条件を満たす必要があります。

**実装箇所**: `FriendService::rejectFriendRequest()` (274-307行目)

---

## まとめ

フレンド申請可能となる条件は以下の通りです：

### **必須条件（すべて満たす必要がある）**
1. 自分自身ではない
2. 既にフレンドではない
3. 既に申請中（pending）ではない
4. 最大フレンド数（10人）に達していない

### **申請条件（以下のいずれかを満たす）**

#### パターン1: 招待関係がある
- ユーザー間で招待関係がある場合、通常の条件を満たさなくても申請可能

#### パターン2: 通常の条件を満たしている
- 同じスレッド内でお互いに10通以上送信
- 双方それぞれ1000文字以上送信
- 12時間以内に相互に送信

### **注意事項**
- 申請が拒否された場合、条件がリセットされ、再度同じ条件を満たす必要があります
- フレンド機能を使用するには、別途「フレンド機能が有効になる条件」を満たす必要があります

